<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LayoutScroll - Vertical + Horizontal</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { background: #222; display: block; }
    </style>
</head>
<body>
<canvas id="canvas"></canvas>

<script>
// --- Renderer ---
class Renderer {
    constructor(ctx) {
        this.ctx = ctx;
    }
    save() { this.ctx.save(); }
    restore() { this.ctx.restore(); }
    drawRect(x, y, w, h, color) {
        this.ctx.fillStyle = color;
        this.ctx.fillRect(x, y, w, h);
    }
    drawText(text, x, y, color, font = "16px Arial", align = "center") {
        this.ctx.fillStyle = color;
        this.ctx.font = font;
        this.ctx.textAlign = align;
        this.ctx.textBaseline = "middle";
        this.ctx.fillText(text, x, y);
    }
}

// --- Widget Base ---
class Widget {
    constructor() {
        this.x = 0; this.y = 0;
        this.width = 0; this.height = 0;
    }
    updateLayout() {}
    render(renderer) {}
    debugDraw(renderer) {
        renderer.ctx.strokeStyle = "red";
        renderer.ctx.strokeRect(this.x, this.y, this.width, this.height);
    }
}

// --- WidgetScrollBar ---
class WidgetScrollBar extends Widget {
    constructor(orientation = "vertical") {
        super();
        this.orientation = orientation;
        this.trackColor = "#444";
        this.thumbColor = "#888";

        this.scrollValue = 0;
        this.visibleRatio = 0.2;

        this.dragging = false;
        this.dragStartMouse = 0;
        this.dragStartScroll = 0;
    }

    render(renderer) {
        renderer.drawRect(this.x, this.y, this.width, this.height, this.trackColor);

        if (this.orientation === "vertical") {
            const thumbHeight = this.height * this.visibleRatio;
            const thumbY = this.y + this.scrollValue * (this.height - thumbHeight);
            this.thumbX = this.x;
            this.thumbY = thumbY;
            this.thumbWidth = this.width;
            this.thumbHeight = thumbHeight;

            renderer.drawRect(this.thumbX, this.thumbY, this.thumbWidth, this.thumbHeight, this.thumbColor);
        } else {
            const thumbWidth = this.width * this.visibleRatio;
            const thumbX = this.x + this.scrollValue * (this.width - thumbWidth);
            this.thumbX = thumbX;
            this.thumbY = this.y;
            this.thumbWidth = thumbWidth;
            this.thumbHeight = this.height;

            renderer.drawRect(this.thumbX, this.thumbY, this.thumbWidth, this.thumbHeight, this.thumbColor);
        }
    }

    setContent(totalSize, viewSize) {
        if (totalSize <= viewSize) {
            this.visibleRatio = 1;
        } else {
            this.visibleRatio = viewSize / totalSize;
        }
    }

    scrollBy(delta) {
        this.scrollValue = Math.max(0, Math.min(1, this.scrollValue + delta));
    }

    isInsideThumb(mx, my) {
        return mx >= this.thumbX && mx <= this.thumbX + this.thumbWidth &&
               my >= this.thumbY && my <= this.thumbY + this.thumbHeight;
    }

    onMouseDown(mx, my) {
        if (this.isInsideThumb(mx, my)) {
            this.dragging = true;
            this.dragStartMouse = (this.orientation === "vertical") ? my : mx;
            this.dragStartScroll = this.scrollValue;
        }
    }

    onMouseMove(mx, my) {
        if (this.dragging) {
            const totalMove = (this.orientation === "vertical") ? my - this.dragStartMouse : mx - this.dragStartMouse;
            const totalLength = (this.orientation === "vertical") ? this.height - this.thumbHeight : this.width - this.thumbWidth;
            if (totalLength > 0) {
                this.scrollValue = this.dragStartScroll + (totalMove / totalLength);
                this.scrollValue = Math.max(0, Math.min(1, this.scrollValue));
            }
        }
    }

    onMouseUp() {
        this.dragging = false;
    }
}

// --- Layout Base ---
class Layout extends Widget {
    constructor() {
        super();
        this.children = [];
    }
    addChild(widget) {
        this.children.push(widget);
    }
    updateLayout() {
        for (let child of this.children) {
            child.updateLayout();
        }
    }
    render(renderer) {
        for (let child of this.children) {
            child.render(renderer);
        }
    }
    debugDraw(renderer) {
        for (let child of this.children) {
            child.debugDraw(renderer);
        }
    }
}

// --- LayoutScroll ---
class LayoutScroll extends Layout {
    constructor() {
        super();
        this.scrollX = 0;
        this.scrollY = 0;
        this.scrollSpeed = 40;

        this.scrollbarVertical = new WidgetScrollBar("vertical");
        this.scrollbarHorizontal = new WidgetScrollBar("horizontal");
        
    }

    updateLayout() {
        for (let child of this.children) {
            child.updateLayout();
        }

        this.contentWidth = 0;
        this.contentHeight = 0;
        for (let child of this.children) {
            this.contentWidth = Math.max(this.contentWidth, child.x + child.width);
            this.contentHeight = Math.max(this.contentHeight, child.y + child.height);
        }

        this.scrollbarVertical.setContent(this.contentHeight, this.height);
        this.scrollbarHorizontal.setContent(this.contentWidth, this.width);
    }

    render(renderer) {
        renderer.save();
        renderer.ctx.beginPath();
        renderer.ctx.rect(this.x, this.y, this.width, this.height);
        renderer.ctx.clip();

        renderer.ctx.translate(this.x - this.scrollX, this.y - this.scrollY);

        for (let child of this.children) 
        {
            child.render(renderer);
        }

        renderer.restore();

        if (this.contentHeight > this.height) 
        {
            this.scrollbarVertical.x = this.x + this.width - 18;
            this.scrollbarVertical.y = this.y;
            this.scrollbarVertical.width = 18;
            this.scrollbarVertical.height = this.height;
            this.scrollbarVertical.render(renderer);
        }

        if (this.contentWidth > this.width) 
        {
            this.scrollbarHorizontal.x = this.x;
            this.scrollbarHorizontal.y = this.y + this.height - 18;
            this.scrollbarHorizontal.width = this.width;
            this.scrollbarHorizontal.height = 18;
            this.scrollbarHorizontal.render(renderer);
        }
    }

    onMouseWheel(deltaY) {
        if (this.contentHeight > this.height) {
            this.scrollY += deltaY * this.scrollSpeed * 0.01;
            this.scrollY = Math.max(0, Math.min(this.scrollY, this.contentHeight - this.height));
            this.scrollbarVertical.scrollValue = this.scrollY / (this.contentHeight - this.height);
        }
        if (this.contentWidth > this.width) {
            this.scrollX += deltaY * this.scrollSpeed * 0.01;
            this.scrollX = Math.max(0, Math.min(this.scrollX, this.contentWidth - this.width));
            this.scrollbarHorizontal.scrollValue = this.scrollX / (this.contentWidth - this.width);
        }
    }

    onMouseDown(mx, my) {
        this.scrollbarVertical.onMouseDown(mx, my);
        this.scrollbarHorizontal.onMouseDown(mx, my);
    }

    onMouseMove(mx, my) {
        this.scrollbarVertical.onMouseMove(mx, my);
        this.scrollbarHorizontal.onMouseMove(mx, my);

        if (this.contentHeight > this.height) {
            this.scrollY = this.scrollbarVertical.scrollValue * (this.contentHeight - this.height);
        }
        if (this.contentWidth > this.width) {
            this.scrollX = this.scrollbarHorizontal.scrollValue * (this.contentWidth - this.width);
        }
    }

    onMouseUp() {
        this.scrollbarVertical.onMouseUp();
        this.scrollbarHorizontal.onMouseUp();
    }
}

// --- Button ---
class Button extends Widget {
    constructor(text, color = "blue") {
        super();
        this.text = text;
        this.color = color;
        this.width = 200;
        this.height = 100;
    }

    render(renderer) {
        renderer.drawRect(this.x, this.y, this.width, this.height, this.color);
        renderer.drawText(this.text, this.x + this.width/2, this.y + this.height/2, "white");
    }
}

// --- Setup ---
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const renderer = new Renderer(ctx);

// LayoutScroll
const layoutScroll = new LayoutScroll();
layoutScroll.x = 20;
layoutScroll.y = 20;
layoutScroll.width = window.innerWidth - 40;
layoutScroll.height = window.innerHeight - 40;

// Adicionar muitos bot√µes
for (let i = 0; i < 40; i++) {
    const btn = new Button("Button " + (i + 1), "#3366cc");
    btn.x = (i % 5) * 250;
    btn.y = Math.floor(i / 5) * 150;
    layoutScroll.addChild(btn);
}

// Resize
window.addEventListener('resize', resizeCanvas);
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    layoutScroll.width = window.innerWidth - 40;
    layoutScroll.height = window.innerHeight - 40;
}
resizeCanvas();

// Eventos de rato
window.addEventListener('wheel', (e) => {
    layoutScroll.onMouseWheel(e.deltaY);
});
window.addEventListener('mousedown', (e) => {
    layoutScroll.onMouseDown(e.clientX, e.clientY);
});
window.addEventListener('mousemove', (e) => {
    layoutScroll.onMouseMove(e.clientX, e.clientY);
});
window.addEventListener('mouseup', () => {
    layoutScroll.onMouseUp();
});

// Loop
function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    layoutScroll.updateLayout();
    layoutScroll.render(renderer);
    layoutScroll.debugDraw(renderer);
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>

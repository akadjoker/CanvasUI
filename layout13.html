<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Layout System Finalizado</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { background: #222; display: block; }
    </style>
</head>
<body>
<canvas id="canvas"></canvas>

<script>
// --- Enums ---
const AlignVertical = { Top: 0, Center: 1, Bottom: 2 };
const AlignHorizontal = { Left: 0, Center: 1, Right: 2 };

// --- Padding Class ---
class Padding {
    constructor(top = 0, bottom = 0, left = 0, right = 0) {
        this.top = top; this.bottom = bottom;
        this.left = left; this.right = right;
    }
    setAll(v) {
        this.top = this.bottom = this.left = this.right = v;
    }
}

// --- Widget Base ---
class Widget {
    constructor() {
        this.x = 0; this.y = 0; this.width = 0; this.height = 0;
        this.alignVertical = AlignVertical.Top;
        this.alignHorizontal = AlignHorizontal.Left;
        this.expandWidth = true;
        this.expandHeight = false;
        this.padding = new Padding();
        this.percent = 0;
        this.parent = null;
    }
    updateLayout() {}
    update(dt) {}
    render(ctx) {}
    debugDraw(ctx) {
        ctx.save();
        ctx.strokeStyle = "red";
        ctx.strokeRect(this.x, this.y, this.width, this.height);
        ctx.restore();
    }
}

// --- Layout Base ---
class Layout extends Widget {
    constructor() {
        super();
        this.children = [];
    }
    addChild(widget, percent = 0) {
        widget.parent = this;
        widget.percent = percent;
        this.children.push(widget);
    }
    removeChild(widget) {
        const idx = this.children.indexOf(widget);
        if (idx !== -1) {
            this.children.splice(idx, 1);
            widget.parent = null;
        }
    }
    clearChildren() {
        for (let child of this.children) {
            child.parent = null;
        }
        this.children = [];
    }
    updateLayout() {
        for (let child of this.children) {
            child.updateLayout();
        }
    }
    render(ctx) {
        for (let child of this.children) {
            child.render(ctx);
        }
    }
    debugDraw(ctx) {
        super.debugDraw(ctx);
        for (let child of this.children) {
            child.debugDraw(ctx);
        }
    }
}

// --- LayoutVertical ---
class LayoutVertical extends Layout {
    constructor() {
        super();
        this.spacing = 0;
    }
    updateLayout() {
        let totalPercent = 0;
        for (let widget of this.children) {
            totalPercent += widget.percent;
        }
        if (totalPercent !== 100) {
            for (let widget of this.children) {
                widget.percent = (widget.percent / totalPercent) * 100;
            }
        }

        let totalHeight = this.height - this.padding.top - this.padding.bottom - (this.children.length - 1) * this.spacing;
        let offsetY = this.y + this.padding.top;
        let x = this.x + this.padding.left;
        let width = this.width - this.padding.left - this.padding.right;

        for (let widget of this.children) {
            widget.x = x;
            widget.y = offsetY;
            widget.width = width;
            widget.height = totalHeight * (widget.percent / 100);

            offsetY += widget.height + this.spacing;

            widget.updateLayout();
        }
    }
}

// --- LayoutHorizontal ---
class LayoutHorizontal extends Layout {
    constructor() {
        super();
        this.spacing = 0;
    }
    updateLayout() {
        let totalPercent = 0;
        for (let widget of this.children) {
            totalPercent += widget.percent;
        }
        if (totalPercent !== 100) {
            for (let widget of this.children) {
                widget.percent = (widget.percent / totalPercent) * 100;
            }
        }

        let totalWidth = this.width - this.padding.left - this.padding.right - (this.children.length - 1) * this.spacing;
        let offsetX = this.x + this.padding.left;
        let y = this.y + this.padding.top;
        let height = this.height - this.padding.top - this.padding.bottom;

        for (let widget of this.children) {
            widget.x = offsetX;
            widget.y = y;
            widget.width = totalWidth * (widget.percent / 100);
            widget.height = height;

            offsetX += widget.width + this.spacing;

            widget.updateLayout();
        }
    }
}

// --- LayoutAlign ---
class LayoutAlign extends Layout {
    constructor() {
        super();
    }
    updateLayout() {
        let availableWidth = this.width - this.padding.left - this.padding.right;
        let availableHeight = this.height - this.padding.top - this.padding.bottom;

        for (let widget of this.children) {
            widget.width = widget.expandWidth ? availableWidth : (widget.fixedWidth || 100);
            widget.height = widget.expandHeight ? availableHeight : (widget.fixedHeight || 40);

            if (widget.alignHorizontal === AlignHorizontal.Left) {
                widget.x = this.x + this.padding.left;
            } else if (widget.alignHorizontal === AlignHorizontal.Center) {
                widget.x = this.x + this.padding.left + (availableWidth - widget.width) / 2;
            } else if (widget.alignHorizontal === AlignHorizontal.Right) {
                widget.x = this.x + this.width - this.padding.right - widget.width;
            }

            if (widget.alignVertical === AlignVertical.Top) {
                widget.y = this.y + this.padding.top;
            } else if (widget.alignVertical === AlignVertical.Center) {
                widget.y = this.y + this.padding.top + (availableHeight - widget.height) / 2;
            } else if (widget.alignVertical === AlignVertical.Bottom) {
                widget.y = this.y + this.height - this.padding.bottom - widget.height;
            }

            widget.updateLayout();
        }
    }
}

// --- Button Widget ---
class Button extends Widget {
    constructor(text, color = "blue") {
        super();
        this.text = text;
        this.color = color;
        this.fixedWidth = 200;
        this.fixedHeight = 40;
    }
    render(ctx) {
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, this.width, this.height);

        ctx.fillStyle = "white";
        ctx.font = "16px Arial";
        ctx.textBaseline = "middle";
        ctx.textAlign = "center";
        ctx.fillText(this.text, this.x + this.width/2, this.y + this.height/2);
    }
}

// --- Setup Canvas ---
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// Root LayoutVertical
const rootLayout = new LayoutVertical();
rootLayout.spacing = 10;
rootLayout.padding.setAll(10);

// TopBar
const topBar = new Button("Top Bar", "#3366cc");

// Body com LayoutHorizontal
const bodyLayout = new LayoutHorizontal();
bodyLayout.spacing = 10;
bodyLayout.padding.setAll(10);

// Sidebar
const sidebar = new LayoutVertical();
sidebar.spacing = 5;
sidebar.addChild(new Button("Menu 1", "#66ccff"), 33);
sidebar.addChild(new Button("Menu 2", "#66ccff"), 33);
sidebar.addChild(new Button("Menu 3", "#66ccff"), 34);

// Content
const contentLayout = new LayoutVertical();
contentLayout.spacing = 5;
contentLayout.addChild(new Button("Content A", "#33cc66"), 50);
contentLayout.addChild(new Button("Content B", "#339966"), 50);

// Montar Body
bodyLayout.addChild(sidebar, 30); // 30% Sidebar
bodyLayout.addChild(contentLayout, 70); // 70% Content

// BottomBar
const bottomBar = new Button("Bottom Bar", "#3366cc");

// Montar Root
rootLayout.addChild(topBar, 10);
rootLayout.addChild(bodyLayout, 80);
rootLayout.addChild(bottomBar, 10);

// Resize
resizeCanvas();

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    rootLayout.x = 0;
    rootLayout.y = 0;
    rootLayout.width = canvas.width;
    rootLayout.height = canvas.height;
}

// Loop
function loop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    rootLayout.updateLayout();
    rootLayout.render(ctx);
    rootLayout.debugDraw(ctx);
    requestAnimationFrame(loop);
}
loop();

window.addEventListener('resize', resizeCanvas);
</script>
</body>
</html>
